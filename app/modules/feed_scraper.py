import requests
from bs4 import BeautifulSoup
import pandas as pd


class FeedScraper():
    def __init__(self) -> None:
        pass

    ### WEB SCRAPER FUNCTIONALITY ###

    def get_soup(base_url):
        r = requests.get(base_url)
        soup = BeautifulSoup(r.text, "html.parser")

        return soup

    # TODO replace with threading or asyncio for better speeds
    def requester(self, article_links, div_type, query_item):
        article_text = []
        for i in range(len(article_links)):
            article = self.get_soup(article_links[i])

            if div_type == "class":
                text = self.div_class_article_text_lookup(
                    article, query_item=query_item)
                article_text.append(text)
            elif div_type == "id":
                text = self.div_id_article_text_lookup(
                    article, query_item=query_item)
                article_text.append(text)
            else:
                break
        # convert scraped text to pandas dataframe
        df_article_text = pd.DataFrame(article_text)
        # transpose df, and turned into a single column
        df_article_text = df_article_text.transpose()
        df_article_text = df_article_text.stack().reset_index()
        df_article_text.columns = ['0', '1', 'text']
        df_article_text = df_article_text[['text']]

        return df_article_text

    def append_links(base_url, article_links):
        appended_links = []
        for i in range(len(article_links)):
            link = str(article_links[i])
            new_link = base_url + link
            appended_links.append(new_link)

        return appended_links

    ### PARSERS ###

    def div_id_link_lookup(self, soup, query_item):
        site_info = soup.find('div', id=query_item)
        # find links to articles in news listing, append to list of links
        raw_links = []
        for link in site_info.find_all('a'):
            raw_links.append(link.get('href'))
        df = self.link_cleaner(raw_links)
        # return as a list
        article_links = df['Links'].to_list()

        return article_links

    def div_id_article_text_lookup(soup, query_item):
        site_info = soup.find('div', id=query_item)
        # find text in articles append to list as text
        article_text = []
        for text in site_info.find_all('p'):
            article_text.append(str(text))

        return article_text

    def div_class_link_lookup(self, soup, query_item):
        site_info = soup.find('div', class_=query_item)
        # find links to articles in news listing, append to list of links
        raw_links = []
        for link in site_info.find_all('a'):
            raw_links.append(link.get('href'))
        df = self.link_cleaner(raw_links)
        # return as a list
        article_links = df['Links'].to_list()

        return article_links

    def div_class_article_text_lookup(soup, query_item):
        site_info = soup.find('div', class_=query_item)
        # find text in articles append to list as text
        article_text = []
        for text in site_info.find_all('p'):
            article_text.append(str(text))

        return article_text

    def link_cleaner(raw_links):
        # de-dupe & clean links, returns a DataFrame
        df = pd.DataFrame(raw_links)
        df.columns = ['Links']
        df.sort_values('Links', inplace=True)
        df.drop_duplicates(subset='Links', keep='first', inplace=True)
        df = df.convert_dtypes()
        if 'author' in df['Links']:
            df = df[~df['Links'].str.contains('author')]
        if 'comment' in df['Links']:
            df = df[~df['Links'].str.contains('comment')]
        if '#modal' in df['Links']:
            df = df[~df['Links'].str.contains('#modal')]
        if 'page/' in df['Links']:
            df = df[~df['Links'].str.contains('page/')]
        """
        # TODO - Doesn't filter these out right now, IDFK why not
        if '?tag' in df['Links']:
            df = df[~df['Links'].str.contains('?tag')]
        if '?offset' in df['Links']:
            df = df[~df['Links'].str.contains('?offset')]
        """
        df = df.dropna()

        return df

    def cve_parser(df_article_text, site):
        # filter down data and extract CVE numbers
        df_cve = df_article_text.loc[df_article_text['text'].str.contains(
            'CVE-', case=True)]
        df_cve = df_cve['text'].str.extractall(r'(CVE-[\d]{4}-[\d]{1,})')
        df_cve.columns = ['CVE']
        df_cve['Site'] = site
        df_cve = df_cve.pivot_table(
            index=['Site', 'CVE'], aggfunc='size')

        return df_cve
